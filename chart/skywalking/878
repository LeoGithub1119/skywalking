---
# Source: skywalking-helm/charts/elasticsearch/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: "skywalking-cluster-master"
  annotations:
  labels:
    heritage: "Helm"
    release: "release-name"
    chart: "elasticsearch-7.17.3"
    app: "skywalking-cluster-master"
---
# Source: skywalking-helm/templates/oap-serviceaccount.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: release-name
    chart: skywalking-helm-4.7.0
    component: "oap"
    heritage: Helm
    release: release-name
  name: release-name-skywalking-helm-oap
---
# Source: skywalking-helm/templates/satellite-serviceaccount.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: release-name
    chart: skywalking-helm-4.7.0
    component: "satellite"
    heritage: Helm
    release: release-name
  name: release-name-skywalking-helm-satellite
---
# Source: skywalking-helm/charts/elasticsearch/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: skywalking-cluster-master-config
  labels:
    heritage: "Helm"
    release: "release-name"
    chart: "elasticsearch"
    app: "skywalking-cluster-master"
data:
  elasticsearch.yml: |
    cluster.name: ${CLUSTER_NAME}
    node.name: ${NODE_NAME}
    network.host: 0.0.0.0
    http.port: 9200
    discovery.seed_hosts: elasticsearch-master-headless
    cluster.initial_master_nodes: elasticsearch-master-0
    xpack.security.enabled: false
    
  log4j2.properties: |
    logger.action.name = org.elasticsearch.action
    logger.action.level = info
    appender.console.type = Console
    appender.console.name = console
    appender.console.layout.type = PatternLayout
    appender.console.layout.pattern = [%d{ISO8601}][%-5p][%-25c] %m%n
    rootLogger.level = info
    rootLogger.appenderRef.console.ref = console
---
# Source: skywalking-helm/templates/oap-cm-override.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: v1
kind: ConfigMap
metadata:
  name: release-name-skywalking-helm-oap-cm-override
  labels:
    app: release-name
    release: release-name
    component: oap
data:
 log4j2.xml: |
    <Configuration status="INFO">
      <Appenders>
        <Console name="Console" target="SYSTEM_OUT">
          <PatternLayout pattern="[%d{ISO8601}][%-5p][%-25c] %m%n"/>
        </Console>
      </Appenders>
      <Loggers>
        <Root level="INFO">
          <AppenderRef ref="Console"/>
        </Root>
      </Loggers>
    </Configuration>
    
 metadata-service-mapping.yaml: |
    serviceName: e2e::${LABELS["service.istio.io/canonical-name"]}
    serviceInstanceName: ${NAME}
    
 oal-core.oal: |
    service_resp_time = from(Service.latency).longAvg();
    service_sla = from(Service.*).percent(status == true);
    service_cpm = from(Service.*).cpm();
    
 ui-initialized-templates-general-general-service.json: |
    [{"id":"General-Service" ... }]
---
# Source: skywalking-helm/templates/satellite-cm-override.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: v1
kind: ConfigMap
metadata:
  name: release-name-skywalking-helm-satellite-cm-override
  labels:
    app: release-name
    release: release-name
    component: satellite
data:
 satellite_config.yaml: |
    selector: default
    receivers:
      - grpc:
          addr: 0.0.0.0:11800
    forwarders:
      - oap:
          addr: skywalking-skywalking-helm-oap:11800
---
# Source: skywalking-helm/templates/oap-clusterrole.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-skywalking-helm
  labels:
    app: release-name
    chart: "skywalking-helm-4.7.0"
    release: "release-name"
    heritage: "Helm"
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log", "endpoints", "services", "nodes", "namespaces", "configmaps"]
  verbs: ["get", "watch", "list"]
- apiGroups: ["extensions"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "watch", "list"]
- apiGroups: ["networking.istio.io"]
  resources: ["serviceentries"]
  verbs: ["get", "watch", "list"]
---
# Source: skywalking-helm/templates/oap-clusterrolebinding.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: release-name-skywalking-helm
  labels:
    app: release-name
    chart: "skywalking-helm-4.7.0"
    release: "release-name"
    heritage: "Helm"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: release-name-skywalking-helm
subjects:
- kind: ServiceAccount
  name: release-name-skywalking-helm-oap
  namespace: skywalking
---
# Source: skywalking-helm/charts/elasticsearch/templates/role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: "skywalking-cluster-master"
  labels:
    heritage: "Helm"
    release: "release-name"
    chart: "elasticsearch-7.17.3"
    app: "skywalking-cluster-master"
rules:
  - apiGroups:
      - extensions
    resources:
      - podsecuritypolicies
    resourceNames:
      - "skywalking-cluster-master"
    verbs:
      - use
---
# Source: skywalking-helm/templates/oap-role.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-skywalking-helm
  labels:
    app: release-name
    chart: "skywalking-helm-4.7.0"
    release: "release-name"
    heritage: "Helm"
rules:
  - apiGroups: [""]
    resources: ["pods","configmaps"]
    verbs: ["get", "watch", "list"]
---
# Source: skywalking-helm/templates/satellite-role.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-skywalking-helm-satellite
  labels:
    app: release-name
    component: "oap"
    chart: "skywalking-helm-4.7.0"
    release: "release-name"
    heritage: "Helm"
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "watch", "list"]
---
# Source: skywalking-helm/charts/elasticsearch/templates/rolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: "skywalking-cluster-master"
  labels:
    heritage: "Helm"
    release: "release-name"
    chart: "elasticsearch-7.17.3"
    app: "skywalking-cluster-master"
subjects:
  - kind: ServiceAccount
    name: "skywalking-cluster-master"
    namespace: "skywalking"
roleRef:
  kind: Role
  name: "skywalking-cluster-master"
  apiGroup: rbac.authorization.k8s.io
---
# Source: skywalking-helm/templates/oap-rolebinding.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: release-name-skywalking-helm
  labels:
    app: release-name
    chart: "skywalking-helm-4.7.0"
    release: "release-name"
    heritage: "Helm"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: release-name-skywalking-helm
subjects:
  - kind: ServiceAccount
    name: release-name-skywalking-helm-oap
    namespace: skywalking
---
# Source: skywalking-helm/templates/satellite-rolebinding.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: release-name-skywalking-helm-satellite
  labels:
    app: release-name
    component: "oap"
    chart: "skywalking-helm-4.7.0"
    release: "release-name"
    heritage: "Helm"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: release-name-skywalking-helm-satellite
subjects:
  - kind: ServiceAccount
    name: release-name-skywalking-helm-satellite
    namespace: skywalking
---
# Source: skywalking-helm/charts/elasticsearch/templates/service.yaml
kind: Service
apiVersion: v1
metadata:
  name: skywalking-cluster-master
  labels:
    heritage: "Helm"
    release: "release-name"
    chart: "elasticsearch"
    app: "skywalking-cluster-master"
  annotations:
    {}
spec:
  type: ClusterIP
  selector:
    release: "release-name"
    chart: "elasticsearch"
    app: "skywalking-cluster-master"
  publishNotReadyAddresses: false
  ports:
  - name: http
    protocol: TCP
    port: 9200
  - name: transport
    protocol: TCP
    port: 9300
---
# Source: skywalking-helm/charts/elasticsearch/templates/service.yaml
kind: Service
apiVersion: v1
metadata:
  name: skywalking-cluster-master-headless
  labels:
    heritage: "Helm"
    release: "release-name"
    chart: "elasticsearch"
    app: "skywalking-cluster-master"
  annotations:
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
spec:
  clusterIP: None # This is needed for statefulset hostnames like elasticsearch-0 to resolve
  # Create endpoints also if the related pod isn't ready
  publishNotReadyAddresses: true
  selector:
    app: "skywalking-cluster-master"
  ports:
  - name: http
    port: 9200
  - name: transport
    port: 9300
---
# Source: skywalking-helm/templates/oap-svc.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: Service
metadata:
  name: release-name-skywalking-helm-oap
  labels:
    app: release-name
    chart: skywalking-helm-4.7.0
    component: "oap"
    heritage: Helm
    release: release-name
spec:
  type: ClusterIP
  ports:
  - port: 11800
    name: grpc
  - port: 12800
    name: rest
  - port: 9411
    name: zipkinreceiver
  selector:
    app: release-name
    component: "oap"
    release: release-name
---
# Source: skywalking-helm/templates/satellite-svc.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: v1
kind: Service
metadata:
  name: release-name-skywalking-helm-satellite
  labels:
    app: release-name
    chart: skywalking-helm-4.7.0
    component: "satellite"
    heritage: Helm
    release: release-name
spec:
  type: ClusterIP
  ports:
  - port: 11800
    name: grpc
  - port: 6060
    name: pprof
  selector:
    app: release-name
    component: "satellite"
    release: release-name
---
# Source: skywalking-helm/templates/ui-svc.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: Service
metadata:
  labels:
    app: release-name
    chart: skywalking-helm-4.7.0
    component: "ui"
    heritage: Helm
    release: release-name
  name: release-name-skywalking-helm-ui
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8080
      protocol: TCP

  selector:
    app: release-name
    component: "ui"
    release: release-name
---
# Source: skywalking-helm/templates/oap-deployment.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: release-name
    chart: skywalking-helm-4.7.0
    component: "oap"
    heritage: Helm
    release: release-name
  name: release-name-skywalking-helm-oap
spec:
  replicas: 2
  selector:
    matchLabels:
      app: release-name
      component: "oap"
      release: release-name
  template:
    metadata:
      labels:
        app: release-name
        component: "oap"
        release: release-name
    spec:
      serviceAccountName: release-name-skywalking-helm-oap
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            podAffinityTerm:
              topologyKey: kubernetes.io/hostname
              labelSelector:
                matchLabels:
                  app: "release-name"
                  release: "release-name"
                  component: "oap"
      initContainers:
      
      - name: wait-for-elasticsearch
        image: busybox:1.30
        imagePullPolicy: IfNotPresent
        command: ['sh', '-c', 'for i in $(seq 1 60); do nc -z -w3 skywalking-cluster-master 9200 && exit 0 || sleep 5; done; exit 1']
      containers:
      - name: oap
        image: skywalking.docker.scarf.sh/apache/skywalking-oap-server:10.2.0
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 6
          initialDelaySeconds: 5
          periodSeconds: 20
          tcpSocket:
            port: 12800

        startupProbe:
          failureThreshold: 9
          periodSeconds: 10
          tcpSocket:
            port: 12800

        readinessProbe:
          initialDelaySeconds: 5
          periodSeconds: 20
          tcpSocket:
            port: 12800

        ports:
        - containerPort: 11800
          name: grpc
        - containerPort: 12800
          name: rest
        - containerPort: 9411
          name: zipkinreceiver
        resources:
          limits:
            cpu: "2"
            memory: 4Gi
          requests:
            cpu: "1"
            memory: 2Gi
        env:
        - name: JAVA_OPTS
          value: "-Dmode=no-init -Xmx2g -Xms2g -Dlogging.level=INFO -Dskywalking.plugin.toolkit.log.use.console=true"
        - name: SW_CLUSTER
          value: "kubernetes"
        - name: SW_CLUSTER_K8S_LABEL
          value: "app=release-name,release=release-name,component=oap"
        - name: SW_CLUSTER_K8S_NAMESPACE
          value: "skywalking"
        - name: SW_CONFIGURATION
          value: "k8s-configmap"
        - name: SW_CONFIG_CONFIGMAP_PERIOD
          value: "60"
        - name: SW_QUERY_ZIPKIN
          value: "default"
        - name: SW_RECEIVER_ZIPKIN
          value: "default"
        - name: SW_RECEIVER_ZIPKIN_REST_PORT
          value: "9411"
        - name: SW_STORAGE_ES_INIT_TIMEOUT
          value: "60"
        - name: SW_STORAGE_ES_REQUEST_TIMEOUT
          value: "30000"

        - name: SKYWALKING_COLLECTOR_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: SW_STORAGE
          value: elasticsearch
        - name: SW_STORAGE_ES_CLUSTER_NODES
          value: "skywalking-cluster-master:9200"

        volumeMounts:
          - name: skywalking-oap-override
            mountPath: /skywalking/config/log4j2.xml
            subPath: log4j2.xml
          - name: skywalking-oap-override
            mountPath: /skywalking/config/metadata-service-mapping.yaml
            subPath: metadata-service-mapping.yaml
          - name: skywalking-oap-override
            mountPath: /skywalking/config/oal/core.oal
            subPath: oal-core.oal
          - name: skywalking-oap-override
            mountPath: /skywalking/config/ui-initialized-templates/general/general-service.json
            subPath: ui-initialized-templates-general-general-service.json

      volumes:
        - name: skywalking-oap-override
          configMap:
            name: release-name-skywalking-helm-oap-cm-override
---
# Source: skywalking-helm/templates/satellite-deployment.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: release-name
    chart: skywalking-helm-4.7.0
    component: "satellite"
    heritage: Helm
    release: release-name
  name: release-name-skywalking-helm-satellite
spec:
  replicas: 1
  selector:
    matchLabels:
      app: release-name
      component: "satellite"
      release: release-name
  template:
    metadata:
      labels:
        app: release-name
        component: "satellite"
        release: release-name
    spec:
      serviceAccountName: release-name-skywalking-helm-satellite
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsUser: 1000

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            podAffinityTerm:
              topologyKey: kubernetes.io/hostname
              labelSelector:
                matchLabels:
                  app: "release-name"
                  release: "release-name"
                  component: "satellite"
      containers:
      - name: satellite
        image: apache/skywalking-satellite:v1.3.0
        imagePullPolicy: IfNotPresent
        readinessProbe:
          tcpSocket:
            port: 11800
          initialDelaySeconds: 15
          periodSeconds: 20
        ports:
        - containerPort: 11800
          name: grpc
        - containerPort: 6060
          name: pprof
        resources:
          limits:
            cpu: 2
            memory: 2Gi
          requests:
            cpu: 1
            memory: 1Gi
        env:
          - name: SATELLITE_GRPC_CLIENT_FINDER
            value: kubernetes
          - name: SATELLITE_GRPC_CLIENT_KUBERNETES_NAMESPACE
            value: "skywalking"
          - name: SATELLITE_GRPC_CLIENT_KUBERNETES_KIND
            value: pod
          - name: SATELLITE_GRPC_CLIENT_KUBERNETES_SELECTOR_LABEL
            value: "app=release-name,release=release-name,component=oap"
          - name: SATELLITE_GRPC_CLIENT_KUBERNETES_EXTRA_PORT
            value: "11800"

        volumeMounts:
          - name: skywalking-satellite-override
            mountPath: /skywalking/config/satellite_config.yaml
            subPath: satellite_config.yaml

      volumes:
        - name: skywalking-satellite-override
          configMap:
            name: release-name-skywalking-helm-satellite-cm-override
---
# Source: skywalking-helm/templates/ui-deployment.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: release-name-skywalking-helm-ui
  labels:
    app: release-name
    chart: skywalking-helm-4.7.0
    component: "ui"
    heritage: Helm
    release: release-name
spec:
  replicas: 1
  selector:
    matchLabels:
      app: release-name
      component: "ui"
      release: release-name
  template:
    metadata:
      labels:
        app: release-name
        component: "ui"
        release: release-name
    spec:

      affinity:
      containers:
      - name: ui
        image: skywalking.docker.scarf.sh/apache/skywalking-ui:10.2.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: page
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 256Mi
        env:
        - name: SW_OAP_ADDRESS
          value: "http://release-name-skywalking-helm-oap:12800"
        - name: SW_ZIPKIN_ADDRESS
          value: "http://skywalking-skywalking-helm-oap:9411"
---
# Source: skywalking-helm/charts/elasticsearch/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: skywalking-cluster-master
  labels:
    heritage: "Helm"
    release: "release-name"
    chart: "elasticsearch"
    app: "skywalking-cluster-master"
  annotations:
    esMajorVersion: "7"
spec:
  serviceName: skywalking-cluster-master-headless
  selector:
    matchLabels:
      app: "skywalking-cluster-master"
  replicas: 1
  podManagementPolicy: Parallel
  updateStrategy:
    type: RollingUpdate
  volumeClaimTemplates:
  - metadata:
      name: skywalking-cluster-master
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: nfs-sc-new
  template:
    metadata:
      name: "skywalking-cluster-master"
      labels:
        release: "release-name"
        chart: "elasticsearch"
        app: "skywalking-cluster-master"
      annotations:
        
        configchecksum: d5ffd51ae0cc849608ab6275630463b5c0f6bc4a1ab8ccc4126d49dde047fcd
    spec:
      securityContext:
        null
      serviceAccountName: "skywalking-cluster-master"
      automountServiceAccountToken: true
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - "skywalking-cluster-master"
            topologyKey: kubernetes.io/hostname
      terminationGracePeriodSeconds: 120
      volumes:
        - name: esconfig
          configMap:
            name: skywalking-cluster-master-config
      enableServiceLinks: true
      initContainers:
      - name: configure-sysctl
        securityContext:
          runAsUser: 0
          privileged: true
        image: "docker.elastic.co/elasticsearch/elasticsearch:7.17.3"
        imagePullPolicy: "IfNotPresent"
        command: ["sysctl", "-w", "vm.max_map_count=262144"]
        resources:
          {}

      containers:
      - name: "elasticsearch"
        securityContext:
          capabilities:
            drop:
            - ALL
          runAsNonRoot: false
          runAsUser: 1000
        image: "docker.elastic.co/elasticsearch/elasticsearch:7.17.3"
        imagePullPolicy: "IfNotPresent"
        readinessProbe:
          exec:
            command:
              - bash
              - -c
              - |
                set -e
                # If the node is starting up wait for the cluster to be ready (request params: "wait_for_status=green&timeout=1s" )
                # Once it has started only check that the node itself is responding
                START_FILE=/tmp/.es_start_file

                # Disable nss cache to avoid filling dentry cache when calling curl
                # This is required with Elasticsearch Docker using nss < 3.52
                export NSS_SDB_USE_CACHE=no

                http () {
                  local path="${1}"
                  local args="${2}"
                  set -- -XGET -s

                  if [ "$args" != "" ]; then
                    set -- "$@" $args
                  fi

                  if [ -n "${ELASTIC_PASSWORD}" ]; then
                    set -- "$@" -u "elastic:${ELASTIC_PASSWORD}"
                  fi

                  curl --output /dev/null -k "$@" "http://127.0.0.1:9200${path}"
                }

                if [ -f "${START_FILE}" ]; then
                  echo 'Elasticsearch is already running, lets check the node is healthy'
                  HTTP_CODE=$(http "/" "-w %{http_code}")
                  RC=$?
                  if [[ ${RC} -ne 0 ]]; then
                    echo "curl --output /dev/null -k -XGET -s -w '%{http_code}' \${BASIC_AUTH} http://127.0.0.1:9200/ failed with RC ${RC}"
                    exit ${RC}
                  fi
                  # ready if HTTP code 200, 503 is tolerable if ES version is 6.x
                  if [[ ${HTTP_CODE} == "200" ]]; then
                    exit 0
                  elif [[ ${HTTP_CODE} == "503" && "7" == "6" ]]; then
                    exit 0
                  else
                    echo "curl --output /dev/null -k -XGET -s -w '%{http_code}' \${BASIC_AUTH} http://127.0.0.1:9200/ failed with HTTP code ${HTTP_CODE}"
                    exit 1
                  fi

                else
                  echo 'Waiting for elasticsearch cluster to become ready (request params: "wait_for_status=green&timeout=1s" )'
                  if http "/_cluster/health?wait_for_status=green&timeout=1s" "--fail" ; then
                    touch ${START_FILE}
                    exit 0
                  else
                    echo 'Cluster is not yet ready (request params: "wait_for_status=green&timeout=1s" )'
                    exit 1
                  fi
                fi
          failureThreshold: 3
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 3
          timeoutSeconds: 5
        ports:
        - name: http
          containerPort: 9200
        - name: transport
          containerPort: 9300
        resources:
          limits:
            cpu: "4"
            memory: 8Gi
          requests:
            cpu: "2"
            memory: 4Gi
        env:
          - name: node.name
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: cluster.initial_master_nodes
            value: "skywalking-cluster-master-0,"
          - name: discovery.seed_hosts
            value: "skywalking-cluster-master-headless"
          - name: cluster.name
            value: "skywalking-cluster"
          - name: network.host
            value: "0.0.0.0"
          - name: cluster.deprecation_indexing.enabled
            value: "false"
          - name: ES_JAVA_OPTS
            value: "-Xmx1g -Xms1g -Xlog:gc*:file=/usr/share/elasticsearch/logs/gc.log:time,tags:filecount=5,filesize=2m"
          - name: node.data
            value: "true"
          - name: node.ingest
            value: "true"
          - name: node.master
            value: "true"
          - name: node.ml
            value: "true"
          - name: node.remote_cluster_client
            value: "true"
          - name: CLUSTER_NAME
            value: skywalking-cluster
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
        volumeMounts:
          - name: "skywalking-cluster-master"
            mountPath: /usr/share/elasticsearch/data

          - name: esconfig
            mountPath: /usr/share/elasticsearch/config/elasticsearch.yml
            subPath: elasticsearch.yml
          - name: esconfig
            mountPath: /usr/share/elasticsearch/config/log4j2.properties
            subPath: log4j2.properties
---
# Source: skywalking-helm/templates/ui-ingress.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  labels:
    app: release-name
    chart: skywalking-helm-4.7.0
    component: "ui"
    heritage: Helm
    release: release-name
  name: release-name-skywalking-helm-ui
  annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  rules:
    - host: skywalking.genai-staging.nchc.org.tw
      http:
        paths:
          - path: /
            backend:
              serviceName: release-name-skywalking-helm-ui
              servicePort: 80
  tls:
    - hosts:
      - skywalking.genai-staging.nchc.org.tw
      secretName: skywalking-ui-tls
---
# Source: skywalking-helm/templates/oap-cm-dynamic.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
# Source: skywalking-helm/charts/elasticsearch/templates/test/test-elasticsearch-health.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "release-name-vhzie-test"
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  securityContext:
    null
  containers:
  - name: "release-name-wezvo-test"
    image: "docker.elastic.co/elasticsearch/elasticsearch:7.17.3"
    imagePullPolicy: "IfNotPresent"
    command:
      - "sh"
      - "-c"
      - |
        #!/usr/bin/env bash -e
        curl -XGET --fail 'skywalking-cluster-master:9200/_cluster/health?wait_for_status=green&timeout=1s'
  restartPolicy: Never
---
# Source: skywalking-helm/templates/oap-init.job.yaml
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# https://docs.sentry.io/server/installation/docker/#running-migrations

apiVersion: batch/v1
kind: Job
metadata:
  name: "release-name-skywalking-helm-oap-init"
  labels:
    app: release-name
    chart: skywalking-helm-4.7.0
    component: "release-name-skywalking-helm-job"
    heritage: Helm
    release: release-name
  annotations:
    "helm.sh/hook": post-install,post-upgrade,post-rollback
    "helm.sh/hook-weight": "1"
spec:
  template:
    metadata:
      name: "release-name-oap-init"
      labels:
        app: release-name
        component: "release-name-skywalking-helm-job"
        release: release-name
    spec:
      serviceAccountName: release-name-skywalking-helm-oap
      restartPolicy: Never
      initContainers:
      
      - name: wait-for-elasticsearch
        image: busybox:1.30
        imagePullPolicy: IfNotPresent
        command: ['sh', '-c', 'for i in $(seq 1 60); do nc -z -w3 skywalking-cluster-master 9200 && exit 0 || sleep 5; done; exit 1']
      containers:
      - name: oap
        image: skywalking.docker.scarf.sh/apache/skywalking-oap-server:10.2.0
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            cpu: "2"
            memory: 4Gi
          requests:
            cpu: "1"
            memory: 2Gi
        env:
        - name: JAVA_OPTS
          value: "-Xmx2g -Xms2g -Dlogging.level=INFO -Dskywalking.plugin.toolkit.log.use.console=true -Dmode=init"
        - name: SW_STORAGE
          value: elasticsearch
        - name: SW_STORAGE_ES_CLUSTER_NODES
          value: "skywalking-cluster-master:9200"
        - name: SW_CONFIGURATION
          value: "k8s-configmap"
        - name: SW_CONFIG_CONFIGMAP_PERIOD
          value: "60"
        - name: SW_QUERY_ZIPKIN
          value: "default"
        - name: SW_RECEIVER_ZIPKIN
          value: "default"
        - name: SW_RECEIVER_ZIPKIN_REST_PORT
          value: "9411"
        - name: SW_STORAGE_ES_INIT_TIMEOUT
          value: "60"
        - name: SW_STORAGE_ES_REQUEST_TIMEOUT
          value: "30000"

        volumeMounts:
          - name: skywalking-oap-override
            mountPath: /skywalking/config/log4j2.xml
            subPath: log4j2.xml
          - name: skywalking-oap-override
            mountPath: /skywalking/config/metadata-service-mapping.yaml
            subPath: metadata-service-mapping.yaml
          - name: skywalking-oap-override
            mountPath: /skywalking/config/oal/core.oal
            subPath: oal-core.oal
          - name: skywalking-oap-override
            mountPath: /skywalking/config/ui-initialized-templates/general
            subPath: ui-initialized-templates-general

      volumes:
        - name: skywalking-oap-override
          configMap:
            name: release-name-skywalking-helm-oap-cm-override
